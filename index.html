import React, { useState, useEffect, useRef, useCallback } from 'react';
import { initializeApp, getApp, getApps } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, query, addDoc, serverTimestamp, updateDoc, increment } from 'firebase/firestore';
import { 
  Zap, Eye, Search, Layers, Sparkle, Dumbbell, ShieldCheck, Briefcase, CreditCard, Cpu, 
  Camera, Upload, RefreshCw, Maximize2, X, CheckCircle2, Lock, Unlock, Key, Database, 
  Mail, Send, UserCheck, BarChart3, Microscope, Droplet, FlaskConical, ClipboardList, 
  Calendar, Phone, Info, ShieldAlert, ArrowRight, Activity as Pulse, LogOut, Fingerprint, 
  ChevronRight, Target, Ruler, FileText, Globe
} from 'lucide-react';

// --- ENTERPRISE CONFIGURATION ---
const apiKey = ""; // Injected at runtime by environment

let app, auth, db, appId;
try {
  const firebaseConfig = JSON.parse(__firebase_config);
  app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
  auth = getAuth(app);
  db = getFirestore(app);
  appId = typeof __app_id !== 'undefined' ? __app_id : 'aura-biometrics-enterprise-v1';
} catch (e) {
  console.error("Biometric Node Offline: Handshake pending...");
}

const App = () => {
  // Navigation State
  const [activeTab, setActiveTab] = useState('overview');
  const [image, setImage] = useState(null);
  const [error, setError] = useState(null);
  
  // AI Diagnostics State
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [isMorphing, setIsMorphing] = useState(false);
  const [analysisResult, setAnalysisResult] = useState(null);
  const [morphUrl, setMorphUrl] = useState(null);
  
  // Enterprise Cloud State
  const [user, setUser] = useState(null);
  const [leads, setLeads] = useState([]);
  const [selectedLead, setSelectedLead] = useState(null);
  const [showLeadForm, setShowLeadForm] = useState(false);
  const [leadSubmitted, setLeadSubmitted] = useState(false);
  const [isSavingLead, setIsSavingLead] = useState(false);
  
  // Provider Access State
  const [showLogin, setShowLogin] = useState(false);
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [loginKey, setLoginKey] = useState('');
  
  // Form Inputs
  const [leadName, setLeadName] = useState('');
  const [leadEmail, setLeadEmail] = useState('');

  // Hardware Interface - REFS
  const [isCameraActive, setIsCameraActive] = useState(false);
  const streamRef = useRef(null);
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const fileInputRef = useRef(null);

  const DEMO_PROVIDER_KEY = "AURA-2026";

  // 1. Auth Lifecycle (Rule 3)
  useEffect(() => {
    if (!auth) return;
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {}
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Data Sync (Rule 1)
  useEffect(() => {
    if (!user || !isLoggedIn || !db) return;
    const leadsRef = collection(db, 'artifacts', appId, 'public', 'data', 'leads');
    const unsubscribe = onSnapshot(leadsRef, (snapshot) => {
      const leadsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setLeads(leadsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
    }, (err) => console.error("Firestore Listen Error:", err));
    return () => unsubscribe();
  }, [user, isLoggedIn]);

  const resetBiometricSession = useCallback(() => {
    setImage(null);
    setAnalysisResult(null);
    setMorphUrl(null);
    setLeadName('');
    setLeadEmail('');
    setLeadSubmitted(false);
    setShowLeadForm(false);
    setError(null);
  }, []);

  const stopCamera = useCallback(() => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
      streamRef.current = null;
    }
    if (videoRef.current) {
      videoRef.current.pause();
      videoRef.current.srcObject = null;
    }
    setIsCameraActive(false);
  }, []);

  const startCamera = async () => {
    try {
      resetBiometricSession();
      const mediaStream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } } 
      });
      streamRef.current = mediaStream;
      setIsCameraActive(true);
    } catch (err) { 
      setError("Camera blocked. Please check browser permissions."); 
      setIsCameraActive(false);
    }
  };

  useEffect(() => {
    if (isCameraActive && videoRef.current) {
      videoRef.current.srcObject = streamRef.current;
    }
  }, [isCameraActive]);

  const capturePhoto = () => {
    if (videoRef.current && canvasRef.current) {
      const canvas = canvasRef.current;
      const video = videoRef.current;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.translate(canvas.width, 0); 
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0);
      setImage(canvas.toDataURL('image/png'));
      stopCamera();
    }
  };

  const analyzeImage = async () => {
    if (!image) return;
    setIsAnalyzing(true);
    setError(null);
    const b64 = image.split(',')[1];
    
    const systemPrompt = `Aura Biometrics Diagnostic v7.0. Output STRICT JSON.
    Include: auraScore (0-1000), faceType (Archetype Name), halos (strengths array), and clinicalRoadmap (4 items).
    
    INTEGRATION MANDATE:
    1. Identify a "Primary Foundation" procedure.
    2. Qualify patient for "Bio-Wellness" (Peptides or IV) based on biometric markers.
    
    JSON Schema: { "auraScore": 750, "faceType": "", "clinicalRoadmap": [{"name": "", "benefit": "", "rationale": "", "estimatedValue": "$3,200", "impactScore": "Primary"}], "halos": [] }`;
    
    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: "Perform structural and wellness diagnostic." }, { inlineData: { mimeType: "image/png", data: b64 } }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { responseMimeType: "application/json" }
        })
      });
      const data = await res.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (!jsonMatch) throw new Error("Parser Error");
      
      setAnalysisResult(JSON.parse(jsonMatch[0]));
      setTimeout(() => setShowLeadForm(true), 1200);
    } catch (err) { 
      setError("Handshake error. Re-initializing engine..."); 
    } finally { 
      setIsAnalyzing(false); 
    }
  };

  const saveLead = async () => {
    if (!db || !analysisResult || !leadName || !leadEmail) return;
    setIsSavingLead(true);
    try {
      const totalVal = (analysisResult.clinicalRoadmap || []).reduce((acc, c) => acc + (parseInt(String(c.estimatedValue || "0").replace(/[^0-9]/g, '')) || 0), 0);
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leads'), {
        name: leadName, 
        email: leadEmail, 
        auraScore: analysisResult.auraScore,
        faceType: analysisResult.faceType,
        fullRoadmap: analysisResult.clinicalRoadmap,
        estValue: `$${totalVal.toLocaleString()}`,
        createdAt: serverTimestamp(), 
        userId: user?.uid
      });
      setLeadSubmitted(true);
    } catch (e) { 
      setError("Cloud sync failure."); 
    } finally { 
      setIsSavingLead(false); 
    }
  };

  const categories = [
    { id: 'overview', name: 'Foundation', icon: <Layers size={14} /> },
    { id: 'vision', name: 'Vision Lab', icon: <Search size={14} /> },
    { id: 'bio', name: 'Wellness', icon: <Sparkle size={14} /> },
    ...(isLoggedIn ? [
      { id: 'enterprise', name: 'Leads', icon: <Briefcase size={14} /> },
      { id: 'billing', name: 'Billing', icon: <CreditCard size={14} /> }
    ] : [])
  ];

  const protocolDetails = {
    overview: { 
      title: "Foundation Protocol", 
      description: "Structural diagnostics for elite patient qualification.", 
      content: [
        { label: "Unified Anatomy Mapping", text: "Cohesive analysis of dermal laxity, fat pad migration, and periosteal foundation." }, 
        { label: "Aging Vectors", text: "Predictive bone loss modeling for preventative clinical planning." }
      ] 
    },
    bio: { 
      title: "Bio-Wellness & Peptide Protocols", 
      description: "Advanced Longevity & Subscription Infrastructure.", 
      content: [
        { label: "GHK-Cu Dermal Signaling", text: "Peptide protocols designed to remodel the ECM and trigger natural collagen density." }, 
        { label: "NAD+ Loading", text: "Mitochondrial energy infusions that defend against cellular senescence." },
        { label: "BPC-157 Healing", text: "Systemic repair signaling to accelerate tissue recovery after procedures." },
        { label: "Metabolic Secretagogues", text: "Monthly CJC-1295 stacks to stimulate natural growth hormone production." }
      ] 
    }
  };

  return (
    <div className="min-h-screen bg-black text-slate-100 font-sans font-black selection:bg-indigo-500/30 overflow-x-hidden pb-32">
      {/* NAV BAR */}
      <nav className="sticky top-0 z-40 bg-black/80 backdrop-blur-xl border-b border-white/5 px-6 py-4 flex items-center justify-between font-black">
        <div className="flex items-center gap-2"><Fingerprint size={18} className="text-indigo-500" /><span className="text-xl uppercase italic text-white tracking-tighter">Aura Biometrics</span></div>
        <div className="hidden lg:flex gap-1">
          {categories.map((cat) => (
            <button key={cat.id} onClick={() => { setActiveTab(cat.id); setMorphUrl(null); }} className={`px-4 py-1.5 rounded-full text-[9px] uppercase tracking-widest border transition-all ${activeTab === cat.id ? 'bg-white text-black border-white shadow-lg' : 'text-slate-500 border-transparent hover:border-white/10'}`}>{cat.name}</button>
          ))}
        </div>
        <button onClick={() => isLoggedIn ? setIsLoggedIn(false) : setShowLogin(true)} className="text-[10px] text-slate-500 uppercase tracking-widest font-black hover:text-white transition-colors">{isLoggedIn ? 'Logout' : 'Login'}</button>
      </nav>

      <main className="max-w-5xl mx-auto px-6 py-10">
        {activeTab === 'vision' ? (
          <div className="space-y-8 animate-in fade-in duration-700">
            <header className="flex flex-col md:flex-row md:items-end justify-between gap-4 font-black">
              <div><h1 className="text-3xl md:text-4xl font-black uppercase tracking-tight leading-none text-white font-black">Vision Lab</h1><p className="text-slate-500 uppercase text-[9px] tracking-widest mt-2 italic">Longevity & Identity Integration</p></div>
              {analysisResult && (<div className="text-right font-black"><div className="text-[9px] text-indigo-400 uppercase mb-1">Aura Score</div><div className="text-4xl italic text-white tabular-nums leading-none font-black">{analysisResult.auraScore}<span className="text-indigo-500 text-lg">/1000</span></div></div>)}
            </header>

            {!image && !isCameraActive ? (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 font-black">
                <button onClick={startCamera} className="p-10 rounded-[2rem] bg-indigo-600/5 border border-white/5 flex flex-col items-center gap-4 text-indigo-400 hover:bg-indigo-600/10 active:scale-95 transition-all"><Camera size={32}/><span className="text-[10px] uppercase tracking-widest font-black">Launch Biometric Cam</span></button>
                <button onClick={() => fileInputRef.current.click()} className="p-10 rounded-[2rem] bg-slate-900 border border-white/5 flex flex-col items-center gap-4 text-slate-400 hover:bg-slate-800 active:scale-95 transition-all"><Upload size={32}/><span className="text-[10px] uppercase tracking-widest font-black">Import Patient Data</span></button>
                <input type="file" ref={fileInputRef} className="hidden" onChange={(e) => { const f = e.target.files[0]; if(f){const r=new FileReader(); r.onload=()=>setImage(r.result); r.readAsDataURL(f);}}} />
              </div>
            ) : isCameraActive ? (
              <div className="relative rounded-[2.5rem] overflow-hidden aspect-[3/4] max-w-sm mx-auto shadow-2xl border border-white/10 bg-slate-950 font-black">
                <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover transform scale-x-[-1]" />
                <div className="absolute bottom-8 left-0 right-0 flex justify-center gap-6"><button onClick={stopCamera} className="p-4 bg-white/10 backdrop-blur-xl rounded-full text-white border border-white/10 hover:bg-rose-500/20"><X size={20}/></button><button onClick={capturePhoto} className="p-6 bg-white rounded-full text-indigo-600 shadow-[0_0_30px_rgba(255,255,255,0.3)] active:scale-90 transition-all"><Maximize2 size={24}/></button></div>
              </div>
            ) : (
              <div className="grid lg:grid-cols-12 gap-8 items-start font-black">
                <div className="lg:col-span-5 space-y-4 font-black">
                  <div className="relative rounded-[2rem] overflow-hidden border border-white/10 bg-slate-900 shadow-2xl"><img src={image} className="w-full grayscale-[0.2]" alt="Patient" />{isAnalyzing && <div className="absolute top-0 left-0 w-full h-1 bg-indigo-500 animate-pulse" />}<button onClick={resetBiometricSession} className="absolute top-4 right-4 p-2 bg-black/60 rounded-full border border-white/10 text-white"><RefreshCw size={16}/></button></div>
                  {!analysisResult && !isAnalyzing && (<button onClick={analyzeImage} className="w-full py-5 bg-white text-black font-black rounded-xl text-[10px] uppercase tracking-widest shadow-xl active:scale-95 transition-all font-black">Generate Diagnostic</button>)}
                  {error && <div className="p-4 bg-rose-500/10 border border-rose-500/20 rounded-xl text-[9px] text-rose-400 text-center uppercase tracking-widest leading-none font-black">{error}</div>}
                </div>
                <div className="lg:col-span-7 space-y-6 font-black">
                  {analysisResult && (
                    <div className="grid gap-4 animate-in slide-in-from-right-10 duration-700 font-black">
                      <div className="grid grid-cols-2 gap-4">
                        <div className="p-5 bg-slate-900 border border-white/10 rounded-2xl min-h-[90px] flex flex-col justify-center shadow-lg overflow-hidden break-words font-black">
                          <div className="text-[8px] text-slate-500 uppercase mb-1 tracking-widest font-black">Archetype</div>
                          <div className="text-sm italic text-white uppercase leading-tight font-black">{analysisResult.faceType || 'Refined'}</div>
                        </div>
                        <div className="p-5 bg-indigo-600/10 border border-indigo-500/20 rounded-2xl min-h-[90px] flex flex-col justify-center shadow-lg font-black">
                          <div className="text-[8px] text-indigo-400 uppercase mb-1 tracking-widest font-black">Primary Halo</div>
                          <div className="text-[11px] font-bold italic text-white font-black">{(analysisResult.halos && analysisResult.halos[0]) || 'Structural'}</div>
                        </div>
                      </div>
                      
                      <section className="space-y-3 relative font-black">
                        <h4 className="text-[9px] text-indigo-400 uppercase tracking-widest px-1 font-black">Clinical & Bio-Wellness Roadmap</h4>
                        <div className={`grid gap-3 transition-all ${!isLoggedIn && !leadSubmitted ? 'blur-xl select-none opacity-30' : ''}`}>
                          {(analysisResult.clinicalRoadmap || []).map((item, i) => (
                            <div key={i} className={`p-5 rounded-2xl border transition-all ${item.name.toLowerCase().includes('pep') || item.name.toLowerCase().includes('iv') ? 'bg-emerald-600/10 border-emerald-500/30 shadow-emerald-600/10' : (i === 0 ? 'bg-indigo-600/10 border-indigo-500/40 shadow-lg' : 'bg-slate-900 border-white/5 opacity-80')}`}>
                                <div className="flex justify-between items-center font-black">
                                    <div className="flex gap-3 items-center">
                                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center font-black ${item.name.toLowerCase().includes('iv') || item.name.toLowerCase().includes('pep') ? 'bg-emerald-500 text-white' : (i === 0 ? 'bg-indigo-500 text-white' : 'bg-white/5 text-indigo-400')}`}>
                                            {item.name.toLowerCase().includes('iv') ? <Droplet size={18}/> : (item.name.toLowerCase().includes('pep') ? <FlaskConical size={18}/> : (i === 0 ? <Zap size={18}/> : <Microscope size={16}/>))}
                                        </div>
                                        <div>
                                            <div className="flex items-center gap-2 font-black"><h5 className="font-black text-white text-[12px] uppercase italic leading-none">{item.name}</h5>{item.name.toLowerCase().includes('pep') && <span className="text-[7px] bg-emerald-500 text-white px-2 py-0.5 rounded-full uppercase">Qualified</span>}</div>
                                            <p className="text-indigo-400 text-[8px] mt-1 uppercase italic font-black">{item.benefit}</p>
                                        </div>
                                    </div>
                                    <div className="text-[11px] text-emerald-400 font-bold italic font-black">{item.estimatedValue}</div>
                                </div>
                                <div className="p-3 bg-black/40 border border-white/5 rounded-lg mt-3"><p className="text-[10px] text-slate-400 italic leading-relaxed font-black">"{item.rationale || item.benefit}"</p></div>
                            </div>
                          ))}
                        </div>
                        {!isLoggedIn && !leadSubmitted && (
                          <div className="absolute inset-0 flex items-center justify-center font-black"><div className="text-center p-6 bg-black/60 backdrop-blur-md rounded-[2rem] border border-white/10 shadow-2xl font-black"><Lock size={20} className="mx-auto mb-3 text-indigo-400 font-black" /><button onClick={() => setShowLeadForm(true)} className="px-6 py-3.5 bg-white text-black font-black text-[9px] uppercase rounded-lg tracking-widest shadow-xl active:scale-95 transition-all">Unlock Roadmap</button></div></div>
                        )}
                      </section>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        ) : activeTab === 'enterprise' && isLoggedIn ? (
          <div className="space-y-10 font-black animate-in fade-in">
             <header className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 text-white">
               <div><h1 className="text-3xl font-black uppercase tracking-tight leading-none font-black font-black">Lead Intelligence</h1><p className="text-slate-500 uppercase text-[9px] font-bold tracking-widest mt-2 italic opacity-60">Aura Biometrics CRM Node</p></div>
               <div className="flex gap-2 font-black">
                 <div className="bg-emerald-500/10 border border-emerald-500/20 px-6 py-4 rounded-2xl font-black"><div className="text-[7px] text-emerald-400 uppercase mb-1 tracking-widest font-black leading-none font-black">Pipeline</div><div className="text-xl italic text-white leading-none font-black font-black">${(leads.reduce((acc, lead) => acc + (parseInt(String(lead.estValue || "").replace(/[^0-9]/g, '')) || 0), 0)).toLocaleString()}</div></div>
                 <div className="bg-indigo-500/10 border border-indigo-500/20 px-6 py-4 rounded-2xl font-black"><div className="text-[7px] text-indigo-400 uppercase mb-1 tracking-widest font-black leading-none font-black">Verified</div><div className="text-xl italic text-white leading-none font-black font-black">{leads.length}</div></div>
               </div>
             </header>
             <div className="space-y-2 font-black">
                {leads.map((l, i) => (
                  <div key={i} className="bg-slate-900/50 p-4 rounded-2xl border border-white/5 flex justify-between items-center hover:border-indigo-500/30 transition-all cursor-pointer font-black" onClick={() => setSelectedLead(l)}>
                    <div className="flex items-center gap-4 font-black font-black"><div className="w-10 h-10 bg-indigo-600/20 rounded-xl flex items-center justify-center text-indigo-400 font-black text-[10px] uppercase font-black">{String(l.name || "").substring(0,2)}</div><div><div className="text-sm font-black uppercase text-white font-black">{String(l.name || "")}</div><div className="text-[9px] text-slate-500 font-bold font-black">{String(l.email || "")}</div></div></div>
                    <div className="flex items-center gap-8 font-black font-black"><div className="text-right hidden md:block font-black"><div className="text-[8px] text-slate-500 uppercase font-black">Score</div><div className="text-sm italic font-black text-white">{l.auraScore}</div></div><div className="text-right font-black"><div className="text-[8px] text-slate-500 uppercase font-black">Potential</div><div className="text-sm font-black italic text-emerald-400 font-black">{l.estValue}</div></div><ChevronRight size={16} className="text-slate-700" /></div>
                  </div>
                ))}
             </div>
          </div>
        ) : (
          <div className="animate-in fade-in duration-700 max-w-3xl mx-auto space-y-6 font-black font-black">
             <h1 className="text-4xl font-black uppercase text-white leading-none font-black">{protocolDetails[activeTab]?.title || activeTab.toUpperCase()}</h1>
             <p className="text-slate-400 text-sm font-medium leading-relaxed italic opacity-80 font-black">{protocolDetails[activeTab]?.description || "Clinical Protocol Module"}</p>
             <div className="grid gap-4">
               {(protocolDetails[activeTab]?.content || []).map((item, idx) => (
                 <div key={idx} className="p-8 rounded-[2rem] border border-white/5 bg-slate-900/40 transition-all hover:bg-slate-900/60 font-black">
                    <div className="flex gap-4 items-start font-black font-black">
                      <div className={`p-3 rounded-xl bg-indigo-600/20 text-indigo-400 font-black`}>{item.label.toLowerCase().includes('iv') ? <Droplet size={18}/> : (item.label.toLowerCase().includes('pep') ? <FlaskConical size={18}/> : <Zap size={18}/>)}</div>
                      <div><h3 className="text-lg uppercase mb-2 text-white leading-none font-black font-black">{item.label}</h3><p className="text-slate-400 font-medium text-xs tracking-wide leading-relaxed font-black">{item.text}</p></div>
                    </div>
                 </div>
               ))}
             </div>
          </div>
        )}
      </main>

      {/* LOGIN MODAL */}
      {showLogin && (
        <div className="fixed inset-0 bg-black/95 backdrop-blur-xl z-[100] flex items-center justify-center p-4">
          <div className="bg-slate-900 border border-white/10 rounded-[2.5rem] max-w-sm w-full p-10 text-center shadow-2xl font-black">
            <Unlock size={32} className="mx-auto mb-6 text-indigo-500 font-black" />
            <input type="password" value={loginKey} onChange={(e) => setLoginKey(e.target.value)} placeholder="Enterprise Key" className="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-center mb-6 outline-none focus:border-indigo-500 text-white font-bold font-black" />
            <button onClick={() => { if(loginKey.toUpperCase() === DEMO_PROVIDER_KEY) {setIsLoggedIn(true); setShowLogin(false); setActiveTab('enterprise');} }} className="w-full py-4 bg-indigo-600 rounded-xl uppercase text-[10px] tracking-widest font-black shadow-lg shadow-indigo-600/20 active:scale-95 transition-all font-black">Authenticate Node</button>
            <button onClick={() => setShowLogin(false)} className="mt-4 text-[10px] text-slate-600 uppercase tracking-widest font-black font-black">Cancel</button>
          </div>
        </div>
      )}

      {/* LEAD CAPTURE MODAL */}
      {showLeadForm && !leadSubmitted && (
        <div className="fixed inset-0 bg-black/95 backdrop-blur-xl z-50 flex items-center justify-center p-4 font-black">
          <div className="bg-slate-900 border border-indigo-500/30 rounded-[3rem] max-w-sm w-full p-10 text-center shadow-2xl font-black">
            <Mail size={32} className="mx-auto mb-6 text-indigo-400 font-black" />
            <h2 className="text-xl text-white uppercase italic mb-6 font-black font-black">Dispatch Biometric Roadmap</h2>
            <div className="space-y-3 mb-8 font-black">
              <input type="text" value={leadName} onChange={(e) => setLeadName(e.target.value)} placeholder="Full Name" className="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm font-black text-white font-black" />
              <input type="email" value={leadEmail} onChange={(e) => setLeadEmail(e.target.value)} placeholder="Secure Email" className="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm font-black text-white font-black" />
            </div>
            <button disabled={isSavingLead || !leadName || !leadEmail} onClick={saveLead} className="w-full py-4 bg-indigo-600 rounded-xl uppercase text-[10px] tracking-widest font-black shadow-lg shadow-indigo-600/30 disabled:opacity-30 transition-all active:scale-95 font-black">Unlock Full Diagnostic</button>
            <button onClick={() => setShowLeadForm(false)} className="mt-4 text-[10px] text-slate-600 uppercase tracking-widest font-black font-black">Skip for now</button>
          </div>
        </div>
      )}

      {/* MOBILE BOTTOM NAV */}
      <div className="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 flex bg-black/80 backdrop-blur-2xl border border-white/10 p-1.5 rounded-full shadow-2xl z-40 max-w-[95vw] overflow-x-auto no-scrollbar scrollbar-hide">
        {categories.map((cat) => (
          <button key={cat.id} onClick={() => { setActiveTab(cat.id); setMorphUrl(null); }} className={`p-3 rounded-full transition-all shrink-0 ${activeTab === cat.id ? 'bg-white text-black scale-105 shadow-lg' : 'text-slate-500'}`}>{cat.icon}</button>
        ))}
      </div>

      <footer className="max-w-5xl mx-auto px-6 py-16 text-center opacity-30 font-black font-black">
        <div className="text-[8px] font-black uppercase tracking-[0.4em] text-slate-600 mb-2 font-black">Aura Biometrics // Revenue Infrastructure Hub</div>
        <div className="text-[7px] font-bold uppercase tracking-widest text-slate-800 font-black">Licensed to Enterprise Gold Tier v7.0</div>
      </footer>
      <canvas ref={canvasRef} className="hidden" />
    </div>
  );
};

export default App;

